[dotenv@17.2.1] injecting env (11) from .env.test -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }
Table TestRoles created successfully. Waiting for it to become active...
Table TestUsers created successfully. Waiting for it to become active...
Table TestAssignments created successfully. Waiting for it to become active...
Table TestPermissions created successfully. Waiting for it to become active...
Table TestPolicies created successfully. Waiting for it to become active...
PASS tests/unit/application/services/user.admin.service.spec.ts (12.618 s)
  ΓùÅ Console

    console.warn
      Cognito user missing 'sub' attribute, using username as ID: test-user

      70 |         const finalUserId = userId ?? cognitoUser.Username ?? 'unknown-id';
      71 |         if (!userId && cognitoUser.Username) {
    > 72 |             console.warn(`Cognito user missing 'sub' attribute, using username as ID: ${cognitoUser.Username}`);
         |                     ^
      73 |         }
      74 |
      75 |         return new AdminUserView(

      at Function.fromCognitoUser (src/domain/entities/AdminUserView.ts:72:21)
      at UserAdminService.<anonymous> (src/application/services/user.admin.service.ts:68:34)
      at fulfilled (src/application/services/user.admin.service.ts:17:58)

    console.warn
      Cognito user missing 'sub' attribute, using username as ID: test-user

      70 |         const finalUserId = userId ?? cognitoUser.Username ?? 'unknown-id';
      71 |         if (!userId && cognitoUser.Username) {
    > 72 |             console.warn(`Cognito user missing 'sub' attribute, using username as ID: ${cognitoUser.Username}`);
         |                     ^
      73 |         }
      74 |
      75 |         return new AdminUserView(

      at Function.fromCognitoUser (src/domain/entities/AdminUserView.ts:72:21)
      at UserAdminService.<anonymous> (src/application/services/user.admin.service.ts:96:34)
      at fulfilled (src/application/services/user.admin.service.ts:17:58)

    console.warn
      Cognito user missing 'sub' attribute, using username as ID: user1

      70 |         const finalUserId = userId ?? cognitoUser.Username ?? 'unknown-id';
      71 |         if (!userId && cognitoUser.Username) {
    > 72 |             console.warn(`Cognito user missing 'sub' attribute, using username as ID: ${cognitoUser.Username}`);
         |                     ^
      73 |         }
      74 |
      75 |         return new AdminUserView(

      at Function.fromCognitoUser (src/domain/entities/AdminUserView.ts:72:21)
      at UserAdminService.<anonymous> (src/application/services/user.admin.service.ts:131:38)
      at fulfilled (src/application/services/user.admin.service.ts:17:58)

    console.warn
      Cognito user missing 'sub' attribute, using username as ID: user1

      70 |         const finalUserId = userId ?? cognitoUser.Username ?? 'unknown-id';
      71 |         if (!userId && cognitoUser.Username) {
    > 72 |             console.warn(`Cognito user missing 'sub' attribute, using username as ID: ${cognitoUser.Username}`);
         |                     ^
      73 |         }
      74 |
      75 |         return new AdminUserView(

      at Function.fromCognitoUser (src/domain/entities/AdminUserView.ts:72:21)
      at UserAdminService.<anonymous> (src/application/services/user.admin.service.ts:131:38)
      at fulfilled (src/application/services/user.admin.service.ts:17:58)

    console.warn
      Cognito user missing 'sub' attribute, using username as ID: user1

      70 |         const finalUserId = userId ?? cognitoUser.Username ?? 'unknown-id';
      71 |         if (!userId && cognitoUser.Username) {
    > 72 |             console.warn(`Cognito user missing 'sub' attribute, using username as ID: ${cognitoUser.Username}`);
         |                     ^
      73 |         }
      74 |
      75 |         return new AdminUserView(

      at Function.fromCognitoUser (src/domain/entities/AdminUserView.ts:72:21)
      at src/application/services/user.admin.service.ts:328:67
          at Array.map (<anonymous>)
      at UserAdminService.<anonymous> (src/application/services/user.admin.service.ts:328:44)
      at fulfilled (src/application/services/user.admin.service.ts:17:58)

FAIL tests/unit/application/services/permission.admin.service.spec.ts (12.659 s)
  ΓùÅ PermissionAdminService ΓÇ║ getPermission ΓÇ║ should return a permission if found

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test-permission"
    Received: "test-tenant", "test-permission"

    Number of calls: 1

      86 |             const result = await service.getPermission(adminUser, permissionName);
      87 |
    > 88 |             expect(permissionRepoMock.findByName).toHaveBeenCalledWith(permissionName);
         |                                                   ^
      89 |             expect(result).toEqual(permissionEntity);
      90 |         });
      91 |

      at tests/unit/application/services/permission.admin.service.spec.ts:88:51
      at fulfilled (tests/unit/application/services/permission.admin.service.spec.ts:5:58)

  ΓùÅ PermissionAdminService ΓÇ║ listPermissions ΓÇ║ should list permissions

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {}
    Received: "test-tenant", {}

    Number of calls: 1

      106 |             const result = await service.listPermissions(adminUser, {});
      107 |
    > 108 |             expect(permissionRepoMock.list).toHaveBeenCalledWith({});
          |                                             ^
      109 |             expect(result).toEqual(permissions);
      110 |         });
      111 |     });

      at tests/unit/application/services/permission.admin.service.spec.ts:108:45
      at fulfilled (tests/unit/application/services/permission.admin.service.spec.ts:5:58)

  ΓùÅ PermissionAdminService ΓÇ║ updatePermission ΓÇ║ should update a permission successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test-permission", {"description": "Updated description"}
    Received: "test-tenant", "test-permission", {"description": "Updated description"}

    Number of calls: 1

      119 |             const result = await service.updatePermission(adminUser, permissionName, updates);
      120 |
    > 121 |             expect(permissionRepoMock.update).toHaveBeenCalledWith(permissionName, updates);
          |                                               ^
      122 |             expect(result).toEqual(updatedPermission);
      123 |         });
      124 |     });

      at tests/unit/application/services/permission.admin.service.spec.ts:121:47
      at fulfilled (tests/unit/application/services/permission.admin.service.spec.ts:5:58)

  ΓùÅ PermissionAdminService ΓÇ║ deletePermission ΓÇ║ should delete a permission and its assignments successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test-permission"
    Received: "test-tenant", "test-permission"

    Number of calls: 1

      131 |             await service.deletePermission(adminUser, permissionName);
      132 |
    > 133 |             expect(permissionRepoMock.delete).toHaveBeenCalledWith(permissionName);
          |                                               ^
      134 |             expect(assignmentRepoMock.removeAllAssignmentsForPermission).toHaveBeenCalledWith(permissionName);
      135 |         });
      136 |

      at tests/unit/application/services/permission.admin.service.spec.ts:133:47
      at fulfilled (tests/unit/application/services/permission.admin.service.spec.ts:5:58)

FAIL tests/unit/application/services/role.admin.service.spec.ts (12.751 s)
  ΓùÅ RoleAdminService ΓÇ║ getRole ΓÇ║ should return a role if found

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test-role"
    Received: "test-tenant", "test-role"

    Number of calls: 1

       96 |             const result = await service.getRole(adminUser, roleName);
       97 |
    >  98 |             expect(roleRepoMock.findByName).toHaveBeenCalledWith(roleName);
          |                                             ^
       99 |             expect(result).toEqual(roleEntity);
      100 |         });
      101 |

      at tests/unit/application/services/role.admin.service.spec.ts:98:45
      at fulfilled (tests/unit/application/services/role.admin.service.spec.ts:5:58)

  ΓùÅ RoleAdminService ΓÇ║ listRoles ΓÇ║ should list roles

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {}
    Received: "test-tenant", {}

    Number of calls: 1

      116 |             const result = await service.listRoles(adminUser, {});
      117 |
    > 118 |             expect(roleRepoMock.list).toHaveBeenCalledWith({});
          |                                       ^
      119 |             expect(result).toEqual(roles);
      120 |         });
      121 |     });

      at tests/unit/application/services/role.admin.service.spec.ts:118:39
      at fulfilled (tests/unit/application/services/role.admin.service.spec.ts:5:58)

  ΓùÅ RoleAdminService ΓÇ║ updateRole ΓÇ║ should update a role successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test-role", {"description": "Updated description"}
    Received: "test-tenant", "test-role", {"description": "Updated description"}

    Number of calls: 1

      129 |             const result = await service.updateRole(adminUser, roleName, updates);
      130 |
    > 131 |             expect(roleRepoMock.update).toHaveBeenCalledWith(roleName, updates);
          |                                         ^
      132 |             expect(result).toEqual(updatedRole);
      133 |         });
      134 |     });

      at tests/unit/application/services/role.admin.service.spec.ts:131:41
      at fulfilled (tests/unit/application/services/role.admin.service.spec.ts:5:58)

  ΓùÅ RoleAdminService ΓÇ║ deleteRole ΓÇ║ should delete a role and its assignments successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test-role"
    Received: "test-tenant", "test-role"

    Number of calls: 1

      141 |             await service.deleteRole(adminUser, roleName);
      142 |
    > 143 |             expect(roleRepoMock.delete).toHaveBeenCalledWith(roleName);
          |                                         ^
      144 |             expect(assignmentRepoMock.removeAllAssignmentsForRole).toHaveBeenCalledWith(roleName);
      145 |         });
      146 |

      at tests/unit/application/services/role.admin.service.spec.ts:143:41
      at fulfilled (tests/unit/application/services/role.admin.service.spec.ts:5:58)

  ΓùÅ RoleAdminService ΓÇ║ assignPermissionToRole ΓÇ║ should assign a permission to a role successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test-role", "test-permission"
    Received: "test-tenant", "test-role", "test-permission"

    Number of calls: 1

      172 |             await service.assignPermissionToRole(adminUser, roleName, permissionName);
      173 |
    > 174 |             expect(assignmentRepoMock.assignPermissionToRole).toHaveBeenCalledWith(roleName, permissionName);
          |                                                               ^
      175 |         });
      176 |
      177 |         it('should throw RoleNotFoundError if role does not exist', async () => {

      at tests/unit/application/services/role.admin.service.spec.ts:174:63
      at fulfilled (tests/unit/application/services/role.admin.service.spec.ts:5:58)

  ΓùÅ RoleAdminService ΓÇ║ removePermissionFromRole ΓÇ║ should remove a permission from a role successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test-role", "test-permission"
    Received: "test-tenant", "test-role", "test-permission"

    Number of calls: 1

      197 |             await service.removePermissionFromRole(adminUser, roleName, permissionName);
      198 |
    > 199 |             expect(assignmentRepoMock.removePermissionFromRole).toHaveBeenCalledWith(roleName, permissionName);
          |                                                                 ^
      200 |         });
      201 |
      202 |         it('should throw AssignmentError on failure', async () => {

      at tests/unit/application/services/role.admin.service.spec.ts:199:65
      at fulfilled (tests/unit/application/services/role.admin.service.spec.ts:5:58)

FAIL tests/unit/application/services/policy.admin.service.spec.ts (12.957 s)
  ΓùÅ PolicyAdminService ΓÇ║ createPolicy ΓÇ║ should create a policy successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, Any<Policy>
    Received: {"createdAt": 2026-02-23T11:16:27.423Z, "description": undefined, "id": "policy-id-123", "isActive": true, "metadata": undefined, "policyDefinition": "def", "policyLanguage": "rego", "policyName": "New Policy", "tenantId": "test-tenant", "updatedAt": 2026-02-23T11:16:27.423Z, "version": 1}

    Number of calls: 1

      38 |             const result = await service.createPolicy(adminUser, details);
      39 |
    > 40 |             expect(policyRepositoryMock.save).toHaveBeenCalledWith(expect.any(String), expect.any(Policy));
         |                                               ^
      41 |             expect(result).toBeInstanceOf(Policy);
      42 |             expect(result.policyName).toBe('New Policy');
      43 |             expect(result.version).toBe(1);

      at tests/unit/application/services/policy.admin.service.spec.ts:40:47
      at fulfilled (tests/unit/application/services/policy.admin.service.spec.ts:5:58)

  ΓùÅ PolicyAdminService ΓÇ║ updatePolicy ΓÇ║ should update a policy successfully, incrementing the version

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, ObjectContaining {"policyName": "Updated Policy", "version": 2}
    Received: {"createdAt": 2026-02-23T11:16:27.403Z, "description": "A test policy", "id": "policy-id-123", "isActive": true, "metadata": {}, "policyDefinition": "def", "policyLanguage": "rego", "policyName": "Updated Policy", "tenantId": "test-tenant", "updatedAt": 2026-02-23T11:16:27.457Z, "version": 2}

    Number of calls: 1

      74 |
      75 |             expect(policyRepositoryMock.findById).toHaveBeenCalledWith(expect.any(String), policyId);
    > 76 |             expect(policyRepositoryMock.save).toHaveBeenCalledWith(expect.any(String), expect.objectContaining({
         |                                               ^
      77 |                 version: policyEntity.version + 1,
      78 |                 policyName: 'Updated Policy'
      79 |             }));

      at tests/unit/application/services/policy.admin.service.spec.ts:76:47
      at fulfilled (tests/unit/application/services/policy.admin.service.spec.ts:5:58)

  ΓùÅ PolicyAdminService ΓÇ║ rollbackPolicy ΓÇ║ should rollback a policy to a specific version

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, ObjectContaining {"id": "new-policy-id", "version": 1}
    Received: {"createdAt": 2026-02-23T11:16:27.493Z, "description": "A test policy", "id": "new-policy-id", "isActive": true, "metadata": {}, "policyDefinition": "old def", "policyLanguage": "rego", "policyName": "Test Policy", "tenantId": "test-tenant", "updatedAt": 2026-02-23T11:16:27.493Z, "version": 1}

    Number of calls: 1

      153 |
      154 |             expect(policyRepositoryMock.getPolicyVersion).toHaveBeenCalledWith(expect.any(String), policyId, 1);
    > 155 |             expect(policyRepositoryMock.save).toHaveBeenCalledWith(expect.any(String), expect.objectContaining({
          |                                               ^
      156 |                 id: 'new-policy-id',
      157 |                 version: 1
      158 |             }));

      at tests/unit/application/services/policy.admin.service.spec.ts:155:47
      at fulfilled (tests/unit/application/services/policy.admin.service.spec.ts:5:58)

PASS tests/unit/application/services/group.admin.service.spec.ts (14.936 s)

Test Suites: 3 failed, 2 passed, 5 total
Tests:       13 failed, 65 passed, 78 total
Snapshots:   0 total
Time:        17.089 s
Ran all test suites matching /unit\\application\\services/i.
Table TestPolicies deleted successfully. Waiting for it to be deleted...
Table TestRoles deleted successfully. Waiting for it to be deleted...
Table TestUsers deleted successfully. Waiting for it to be deleted...
Table TestPermissions deleted successfully. Waiting for it to be deleted...
Table TestAssignments deleted successfully. Waiting for it to be deleted...
